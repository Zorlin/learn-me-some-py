# Level 6: Metaclasses

[concept]
id = "metaclasses"
name = "Metaclasses: Classes for Classes"
level = 6
category = "meta_programming"
order = 3

[content]
lesson = """
## Classes That Create Classes

Metaclasses control how classes are created:

```python
# Every class is an instance of type
class Dog:
    pass

print(type(Dog))  # <class 'type'>
print(type(type)) # <class 'type'>  # Mind-bending!
```

## Custom Metaclass

```python
class SingletonMeta(type):
    _instances = {}

    def __call__(cls, *args, **kwargs):
        if cls not in cls._instances:
            cls._instances[cls] = super().__call__(*args, **kwargs)
        return cls._instances[cls]

class Database(metaclass=SingletonMeta):
    def __init__(self):
        print("Connecting...")

db1 = Database()  # Connecting...
db2 = Database()  # (nothing)
print(db1 is db2)  # True - same instance!
```

## Auto-Registration Pattern

```python
class PluginMeta(type):
    plugins = {}

    def __new__(mcs, name, bases, attrs):
        cls = super().__new__(mcs, name, bases, attrs)
        if name != 'Plugin':
            mcs.plugins[name] = cls
        return cls

class Plugin(metaclass=PluginMeta):
    pass

class SpellCheck(Plugin):
    pass

class Grammar(Plugin):
    pass

print(PluginMeta.plugins)
# {'SpellCheck': <class 'SpellCheck'>, 'Grammar': <class 'Grammar'>}
```

## __new__ vs __init__

```python
class Meta(type):
    def __new__(mcs, name, bases, attrs):
        # Creates the class
        print(f"Creating {name}")
        return super().__new__(mcs, name, bases, attrs)

    def __init__(cls, name, bases, attrs):
        # Initializes the class
        print(f"Initializing {name}")
        super().__init__(name, bases, attrs)
```

## When to Use Metaclasses

- ORMs (Django models)
- Plugin architectures
- Enforcing API contracts
- Auto-registration systems

But remember Tim Peters' advice:
> "If you wonder whether you need metaclasses, you don't."

Most of the time, decorators or `__init_subclass__` are simpler.

## Simpler Alternative: __init_subclass__

```python
class Plugin:
    plugins = {}

    def __init_subclass__(cls, **kwargs):
        super().__init_subclass__(**kwargs)
        Plugin.plugins[cls.__name__] = cls

class SpellCheck(Plugin):
    pass

print(Plugin.plugins)  # {'SpellCheck': <class 'SpellCheck'>}
```
"""

[content.try_it]
prompt = "Create a metaclass that adds a 'created_by' attribute to all classes"
starter = '''
class AddCreatorMeta(type):
    # Add 'created_by = "metaclass"' to all classes
    pass

class MyClass(metaclass=AddCreatorMeta):
    pass

print(MyClass.created_by)  # Should print "metaclass"
'''
solution = '''
class AddCreatorMeta(type):
    def __new__(mcs, name, bases, attrs):
        attrs['created_by'] = 'metaclass'
        return super().__new__(mcs, name, bases, attrs)

class MyClass(metaclass=AddCreatorMeta):
    pass

print(MyClass.created_by)  # metaclass
'''

[connections]
prerequisites = ["classes", "decorators", "magic_methods"]
enables = []
used_in = []
see_also = ["classes", "decorators"]

[meta]
time_to_read = 60
difficulty = "expert"
tags = ["metaclasses", "metaprogramming", "type"]
