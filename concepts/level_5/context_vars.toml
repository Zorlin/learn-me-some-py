# Level 5: Context Variables

[concept]
id = "context_vars"
name = "Context Variables: Safe Global State"
level = 5
category = "concurrency"
order = 5

[content]
lesson = """
## Thread-Safe and Async-Safe Globals

Context variables provide isolated state per execution context:

```python
from contextvars import ContextVar
import asyncio

request_id: ContextVar[str] = ContextVar('request_id', default='none')

async def handle_request(req_id: str):
    request_id.set(req_id)
    await do_work()

async def do_work():
    # Each async task sees its own request_id!
    print(f"Working on: {request_id.get()}")

# Each concurrent request has isolated context
await asyncio.gather(
    handle_request("req-001"),
    handle_request("req-002"),
)
# Working on: req-001
# Working on: req-002
```

## Why Not Global Variables?

```python
# WRONG - shared across all tasks!
current_user = None

async def handle(user):
    global current_user
    current_user = user  # Race condition!
    await process()

# RIGHT - isolated per task
current_user = ContextVar('current_user')

async def handle(user):
    current_user.set(user)  # Isolated
    await process()
```

## Get and Set

```python
from contextvars import ContextVar

counter = ContextVar('counter', default=0)

# Get value
value = counter.get()  # 0

# Set value
counter.set(42)
print(counter.get())  # 42

# Get with fallback
counter.get('fallback')  # Use if not set
```

## Perfect For

- Request IDs in web frameworks
- User context in async applications
- Structured logging
- Per-request database transactions

```python
# Automatic logging context
request_id = ContextVar('request_id', default='no-request')

class ContextFilter(logging.Filter):
    def filter(self, record):
        record.request_id = request_id.get()
        return True

# All logs automatically include request_id
```
"""

[content.try_it]
prompt = "Create a context variable for tracking the current user"
starter = '''
from contextvars import ContextVar

# Create user context variable

def set_user(name):
    # Set the current user
    pass

def get_user():
    # Get the current user
    pass

set_user("Alice")
print(get_user())  # Should print "Alice"
'''
solution = '''
from contextvars import ContextVar

current_user: ContextVar[str] = ContextVar('current_user', default='anonymous')

def set_user(name):
    current_user.set(name)

def get_user():
    return current_user.get()

set_user("Alice")
print(get_user())  # Alice
'''

[connections]
prerequisites = ["async_await"]
enables = []
used_in = []
see_also = ["async_await"]

[meta]
time_to_read = 50
difficulty = "advanced"
tags = ["contextvars", "concurrency", "async"]
