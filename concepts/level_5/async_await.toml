# Level 5: Async/Await

[concept]
id = "async_await"
name = "Async/Await: Concurrent Code"
level = 5
category = "concurrency"
order = 6

[content]
lesson = """
## Do Multiple Things Without Waiting

Async lets code pause at `await` points to let other tasks run:

```python
import asyncio

async def fetch_data(url):
    print(f"Starting {url}")
    await asyncio.sleep(1)  # Pause here
    print(f"Done {url}")
    return f"Data from {url}"

async def main():
    # Run all three concurrently!
    results = await asyncio.gather(
        fetch_data("api/users"),
        fetch_data("api/posts"),
        fetch_data("api/comments"),
    )
    print(results)

asyncio.run(main())
```

## Key Concepts

```python
# async def = coroutine function
async def greet():
    return "Hello"

# await = pause and wait for result
result = await greet()

# asyncio.run() = run async code from sync
asyncio.run(main())
```

## Common Mistake: Forgetting await

```python
# WRONG - returns coroutine object, doesn't run!
result = fetch_data()  # <coroutine object>

# RIGHT - actually runs and gets result
result = await fetch_data()
```

## Never Block in Async

```python
# WRONG - blocks entire event loop!
async def bad():
    time.sleep(1)  # Don't use time.sleep!

# RIGHT - yields control
async def good():
    await asyncio.sleep(1)
```

## Run Tasks Concurrently

```python
# Sequential (slow)
result1 = await task1()
result2 = await task2()

# Concurrent (fast)
results = await asyncio.gather(task1(), task2())
```

## Perfect For

- HTTP requests (aiohttp)
- Database queries (asyncpg)
- WebSockets
- Any I/O-bound operations

**NOT for CPU-bound tasks** - use multiprocessing instead.

## Quick Example: Download Multiple Pages

```python
import asyncio
import aiohttp

async def fetch(session, url):
    async with session.get(url) as response:
        return await response.text()

async def main():
    urls = ["http://example.com"] * 10

    async with aiohttp.ClientSession() as session:
        tasks = [fetch(session, url) for url in urls]
        results = await asyncio.gather(*tasks)

    print(f"Downloaded {len(results)} pages")

asyncio.run(main())
```
"""

[content.try_it]
prompt = "Write an async function that prints numbers with delays"
starter = '''
import asyncio

async def count(name, n):
    # Print 1 to n with 0.5 second delays
    pass

async def main():
    await asyncio.gather(
        count("A", 3),
        count("B", 3),
    )

asyncio.run(main())
# Should interleave: A:1, B:1, A:2, B:2, ...
'''
solution = '''
import asyncio

async def count(name, n):
    for i in range(1, n + 1):
        print(f"{name}:{i}")
        await asyncio.sleep(0.5)

async def main():
    await asyncio.gather(
        count("A", 3),
        count("B", 3),
    )

asyncio.run(main())
'''

[connections]
prerequisites = ["functions", "exceptions", "generators"]
enables = ["context_vars"]
used_in = []
see_also = ["generators"]

[meta]
time_to_read = 60
difficulty = "advanced"
tags = ["async", "await", "concurrency"]
